
name: Fetch All Open Pull Request SHAs
on:
  push:
  workflow_dispatch:
jobs:
  fetch_all_pull_request_shas:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        runtime: [ linux, mac, windows ]
        include:
          - runtime: linux
            os: ubuntu-latest
          - runtime: mac
            os: macOS-latest
          - runtime: windows
            os: windows-latest
    steps:
    - name: Fetch all opened pull request numbers and merge commit SHAs
      shell: bash
      id: fetch_all_pull_requests
      run: |
          latest_pr_info=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/redhat-developer/lsp4ij/pulls?state=open&sort=created&direction=desc&per_page=1" \
          | jq -r 'first | "\(.number) \(.merge_commit_sha)"')
          
          latest_pr_number=$(echo $latest_pr_info | awk '{print $1}')
          latest_pr_merge_sha=$(echo $latest_pr_info | awk '{print $2}')
          
          echo "LATEST_PR_NUMBER=$latest_pr_number" >> $GITHUB_ENV
          echo "LATEST_PR_MERGE_SHA=$latest_pr_merge_sha" >> $GITHUB_ENV
          echo "Latest Pull Request Number: $latest_pr_number"
          echo "Latest Pull Request Merge SHA: $latest_pr_merge_sha"
          
  example_matrix:
    runs-on: ${{ matrix.os }}
    needs: fetch_all_pull_request_shas
    strategy:
      matrix:
        runtime: [ linux, mac, windows ]
        include:
          - runtime: linux
            os: ubuntu-latest
          - runtime: mac
            os: macOS-latest
          - runtime: windows
            os: windows-latest
        merge-commit: [5fb435b608e16982d70dfcec76938328c8763b4b,6543dacb85f3bc1532e5ccfe34dfd04a5eabeaa8]
    steps:
      - name: Checkout pull request merge commits
        uses: actions/checkout@v3
        with:
          repository: redhat-developer/lsp4ij
          ref: ${{ matrix.merge-commit }}
